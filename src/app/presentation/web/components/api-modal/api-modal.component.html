<ion-modal [isOpen]="isOpen" (didDismiss)="close()" class="api-management-modal">
    <ng-template>
        <div class="modal-wrapper" [class.is-viewing]="mode === 'view'">
            <!-- Navigation Arrows -->
            <button class="nav-arrow prev" *ngIf="hasPrevious && mode !== 'add'" (click)="prev.emit()" title="Anterior">
                <mat-icon>chevron_left</mat-icon>
            </button>
            <button class="nav-arrow next" *ngIf="hasNext && mode !== 'add'" (click)="next.emit()" title="Siguiente">
                <mat-icon>chevron_right</mat-icon>
            </button>

            <div class="modal-header">
                <div class="header-icon">
                    <mat-icon>{{ mode === 'add' ? 'add_link' : 'settings_ethernet' }}</mat-icon>
                </div>
                <div class="header-text">
                    <h2>{{ mode === 'add' ? 'Nueva API' : mode === 'edit' ? 'Editar Configuración' : 'Detalles de la
                        API' }}</h2>
                    <p>{{ mode === 'view' ? 'Configuración actual del servicio' : 'Define los parámetros de conexión' }}
                    </p>
                </div>
                <button class="close-btn" (click)="close()">
                    <mat-icon>close</mat-icon>
                </button>
            </div>

            <div class="modal-body">
                <form #apiForm="ngForm">
                <div class="form-grid">
                    <div class="form-group full">
                        <label>Nombre del Servicio</label>
                        <input type="text" name="apiName" [(ngModel)]="api.name" [disabled]="mode === 'view'"
                            placeholder="Ej. PlantNet API"
                            required minlength="3" maxlength="100"
                            #apiName="ngModel">
                        <div class="field-error" *ngIf="apiName.invalid && apiName.touched">
                            <span *ngIf="apiName.errors?.['required']">Este campo es obligatorio.</span>
                            <span *ngIf="apiName.errors?.['minlength']">Mínimo {{ apiName.errors?.['minlength'].requiredLength }} caracteres.</span>
                            <span *ngIf="apiName.errors?.['maxlength']">Máximo {{ apiName.errors?.['maxlength'].requiredLength }} caracteres.</span>
                        </div>
                    </div>

                    <div class="form-group full">
                        <label>Base URL</label>
                        <input type="text" name="baseUrl" [(ngModel)]="api.base_url" [disabled]="mode === 'view'"
                            placeholder="https://api.ejemplo.com/v1"
                            required pattern="https?://.+"
                            #baseUrl="ngModel">
                        <div class="field-error" *ngIf="baseUrl.invalid && baseUrl.touched">
                            <span *ngIf="baseUrl.errors?.['required']">Este campo es obligatorio.</span>
                            <span *ngIf="baseUrl.errors?.['pattern']">Debe ser una URL válida que comience con http:// o https://</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Tipo de Autenticación</label>
                        <select name="authType" [(ngModel)]="api.authType" [disabled]="mode === 'view'">
                            <option value="None">Sin Autenticación</option>
                            <option value="API Key">API Key</option>
                            <option value="OAuth2">OAuth 2.0</option>
                            <option value="Basic Auth">Basic Auth</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Rate Limit</label>
                        <input type="text" name="rateLimit" [(ngModel)]="api.rateLimit" [disabled]="mode === 'view'"
                            placeholder="Ej. 100 req/min" maxlength="50">
                    </div>

                    <div class="form-group full">
                        <label>Descripción</label>
                        <textarea name="description" [(ngModel)]="api.description" [disabled]="mode === 'view'"
                            rows="3" maxlength="500"></textarea>
                    </div>
                </div>

                <div class="endpoints-section">
                    <div class="section-header">
                        <h3>Endpoints Configurados</h3>
                        <button *ngIf="mode !== 'view'" class="btn-add-mini" type="button" (click)="addEndpoint()">
                            <mat-icon>add</mat-icon> Agregar Endpoint
                        </button>
                    </div>

                    <div class="endpoints-list">
                        <div *ngFor="let edp of api.endpoints; let i = index" class="endpoint-card">
                            <div class="edp-header">
                                <span class="method-tag" [ngClass]="edp.method.toLowerCase()">{{ edp.method }}</span>
                                <div class="edp-name-wrapper" style="flex:1">
                                    <input type="text" [name]="'epName' + i" [(ngModel)]="edp.name"
                                        [disabled]="mode === 'view'"
                                        class="edp-name-input" placeholder="Nombre del endpoint"
                                        required minlength="2" maxlength="50"
                                        #epName="ngModel">
                                    <div class="field-error" *ngIf="epName.invalid && epName.touched">
                                        <span *ngIf="epName.errors?.['required']">Este campo es obligatorio.</span>
                                        <span *ngIf="epName.errors?.['minlength']">Mínimo {{ epName.errors?.['minlength'].requiredLength }} caracteres.</span>
                                    </div>
                                </div>
                                <button *ngIf="mode !== 'view'" type="button" class="btn-remove" (click)="removeEndpoint(i)">
                                    <mat-icon>delete</mat-icon>
                                </button>
                            </div>
                            <div class="edp-body">
                                <div>
                                    <input type="text" [name]="'epPath' + i" [(ngModel)]="edp.path"
                                        [disabled]="mode === 'view'"
                                        class="edp-path-input" placeholder="/ruta/del/recurso"
                                        required pattern="/.*"
                                        #epPath="ngModel">
                                    <div class="field-error" *ngIf="epPath.invalid && epPath.touched">
                                        <span *ngIf="epPath.errors?.['required']">Este campo es obligatorio.</span>
                                        <span *ngIf="epPath.errors?.['pattern']">La ruta debe comenzar con /</span>
                                    </div>
                                </div>
                                <div class="edp-footer">
                                    <input type="text" [name]="'epDesc' + i" [(ngModel)]="edp.description"
                                        [disabled]="mode === 'view'"
                                        class="edp-desc-input" placeholder="Descripción breve...">
                                    <div class="edp-method-wrapper">
                                        <select [name]="'epMethod' + i" [(ngModel)]="edp.method"
                                            [disabled]="mode === 'view'"
                                            required #epMethod="ngModel">
                                            <option value="GET">GET</option>
                                            <option value="POST">POST</option>
                                            <option value="PUT">PUT</option>
                                            <option value="DELETE">DELETE</option>
                                            <option value="PATCH">PATCH</option>
                                        </select>
                                        <div class="field-error" *ngIf="epMethod.invalid && epMethod.touched">
                                            <span *ngIf="epMethod.errors?.['required']">Selecciona un método.</span>
                                        </div>
                                    </div>
                                    <div class="toggle-box">
                                        <span>Activo</span>
                                        <ion-toggle [name]="'epActive' + i" [(ngModel)]="edp.isActive"
                                            [disabled]="mode === 'view'"></ion-toggle>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div *ngIf="api.endpoints.length === 0" class="empty-endpoints">
                            <mat-icon>link_off</mat-icon>
                            <p>No hay endpoints definidos para esta API</p>
                        </div>
                    </div>
                </div>
                </form>
            </div>

            <div class="modal-footer" *ngIf="mode !== 'view'">
                <button class="btn-cancel" (click)="close()">Cancelar</button>
                <button class="btn-save" (click)="onSave()">
                    {{ mode === 'add' ? 'Crear API' : 'Guardar Cambios' }}
                </button>
            </div>

            <div class="modal-footer" *ngIf="mode === 'view'">
                <button class="btn-cancel" (click)="close()">Cerrar</button>
                <button class="btn-save" (click)="setMode('edit')">
                    <mat-icon>edit</mat-icon> Editar Configuración
                </button>
            </div>
        </div>
    </ng-template>
</ion-modal>

<app-confirmation-modal [isOpen]="showConfirmModal" title="Confirmar Cambios"
    message="¿Estás seguro de que deseas guardar los cambios en la configuración de esta API?" icon="api"
    confirmColor="var(--accent-color)" confirmText="Guardar" (confirmed)="executeSave()"
    (cancelled)="showConfirmModal = false">
</app-confirmation-modal>
