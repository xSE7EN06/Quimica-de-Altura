<ion-modal [isOpen]="isOpen" (didDismiss)="close()" class="article-management-modal">
    <ng-template>
        <div class="modal-container">
            <!-- Navigation Arrows — outside the card -->
            <button class="nav-arrow prev" *ngIf="hasPrevious && mode !== 'add'" (click)="prev.emit()" title="Anterior">
                <mat-icon>chevron_left</mat-icon>
            </button>
            <button class="nav-arrow next" *ngIf="hasNext && mode !== 'add'" (click)="next.emit()" title="Siguiente">
                <mat-icon>chevron_right</mat-icon>
            </button>

        <div class="modal-wrapper" [class.is-viewing]="mode === 'view'">
            <div class="modal-header">
                <div class="header-icon">
                    <mat-icon>{{ mode === 'add' ? 'library_add' : 'menu_book' }}</mat-icon>
                </div>
                <div class="header-text">
                    <h2>{{ mode === 'add' ? 'Nuevo Artículo' : mode === 'edit' ? 'Editar Artículo' : 'Ficha Técnica de
                        Investigación' }}</h2>
                    <p>{{ mode === 'view' ? 'Detalles de la publicación académica' : 'Ingresa la información
                        bibliográfica y técnica' }}</p>
                </div>
                <button class="close-btn" (click)="close()">
                    <mat-icon>close</mat-icon>
                </button>
            </div>

            <div class="modal-body">
                <!-- File Upload Zone (Only in Add mode) -->
                <div *ngIf="mode === 'add'" class="upload-container" (drop)="onFileDropped($event)"
                    (dragover)="onDragOver($event)">
                    <div class="drop-zone">
                        <mat-icon>cloud_upload</mat-icon>
                        <p>Arrastra tu artículo aquí o <span>haz clic para buscar</span></p>
                        <input type="file" (change)="onFileSelected($event)" accept=".pdf,.doc,.docx,.txt">
                    </div>
                </div>

                <form [formGroup]="articleForm" class="form-grid">
                    <div class="form-group full">
                        <label>Título de la Investigación</label>
                        <input type="text" formControlName="title" [disabled]="mode === 'view'"
                            placeholder="Ej. Análisis de alcaloides en plantas medicinales...">
                        <div class="field-error" *ngIf="articleForm.get('title')?.invalid && articleForm.get('title')?.touched">
                            <span *ngIf="articleForm.get('title')?.errors?.['required']">Este campo es obligatorio.</span>
                            <span *ngIf="articleForm.get('title')?.errors?.['minlength']">Mínimo {{ articleForm.get('title')?.errors?.['minlength'].requiredLength }} caracteres.</span>
                            <span *ngIf="articleForm.get('title')?.errors?.['maxlength']">Máximo {{ articleForm.get('title')?.errors?.['maxlength'].requiredLength }} caracteres.</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Año de Publicación</label>
                        <input type="number" formControlName="year" [disabled]="mode === 'view'">
                        <div class="field-error" *ngIf="articleForm.get('year')?.invalid && articleForm.get('year')?.touched">
                            <span *ngIf="articleForm.get('year')?.errors?.['required']">Este campo es obligatorio.</span>
                            <span *ngIf="articleForm.get('year')?.errors?.['min']">El año mínimo es 1900.</span>
                            <span *ngIf="articleForm.get('year')?.errors?.['max']">El año no puede ser mayor al actual ({{ currentYear }}).</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>País de Origen</label>
                        <input type="text" formControlName="country" [disabled]="mode === 'view'"
                            placeholder="México, Perú, etc.">
                        <div class="field-error" *ngIf="articleForm.get('country')?.invalid && articleForm.get('country')?.touched">
                            <span *ngIf="articleForm.get('country')?.errors?.['required']">Este campo es obligatorio.</span>
                            <span *ngIf="articleForm.get('country')?.errors?.['minlength']">Mínimo {{ articleForm.get('country')?.errors?.['minlength'].requiredLength }} caracteres.</span>
                            <span *ngIf="articleForm.get('country')?.errors?.['maxlength']">Máximo {{ articleForm.get('country')?.errors?.['maxlength'].requiredLength }} caracteres.</span>
                        </div>
                    </div>

                    <div class="form-group full">
                        <label>URL / DOI</label>
                        <input type="text" formControlName="doi" [disabled]="mode === 'view'"
                            placeholder="https://doi.org/10.xxxx/xxxx">
                        <div class="field-error" *ngIf="articleForm.get('doi')?.invalid && articleForm.get('doi')?.touched">
                            <span *ngIf="articleForm.get('doi')?.errors?.['required']">Este campo es obligatorio.</span>
                            <span *ngIf="articleForm.get('doi')?.errors?.['pattern']">Debe ser una URL válida o un DOI con formato 10.XXXX/...</span>
                        </div>
                    </div>

                    <div class="form-group full">
                        <label>Autores (Separados por coma)</label>
                        <input type="text" formControlName="authors" [disabled]="mode === 'view'"
                            placeholder="Pérez, J., Smith, A., etc.">
                        <div class="field-error" *ngIf="articleForm.get('authors')?.invalid && articleForm.get('authors')?.touched">
                            <span *ngIf="articleForm.get('authors')?.errors?.['required']">Este campo es obligatorio.</span>
                            <span *ngIf="articleForm.get('authors')?.errors?.['minlength']">Mínimo {{ articleForm.get('authors')?.errors?.['minlength'].requiredLength }} caracteres.</span>
                            <span *ngIf="articleForm.get('authors')?.errors?.['maxlength']">Máximo {{ articleForm.get('authors')?.errors?.['maxlength'].requiredLength }} caracteres.</span>
                        </div>
                    </div>

                    <div class="form-group full">
                        <label>Palabras Clave (Separadas por coma, opcional)</label>
                        <input type="text" formControlName="keywords" [disabled]="mode === 'view'"
                            placeholder="Química, Botánica, Medicina...">
                        <div class="field-error" *ngIf="articleForm.get('keywords')?.invalid && articleForm.get('keywords')?.touched">
                            <span *ngIf="articleForm.get('keywords')?.errors?.['maxlength']">Máximo {{ articleForm.get('keywords')?.errors?.['maxlength'].requiredLength }} caracteres.</span>
                        </div>
                    </div>

                    <div class="form-group full">
                        <label>Resumen / Abstract</label>
                        <textarea formControlName="abstract" [disabled]="mode === 'view'" rows="6"
                            placeholder="Resumen detallado de la investigación..."></textarea>
                        <div class="field-error" *ngIf="articleForm.get('abstract')?.invalid && articleForm.get('abstract')?.touched">
                            <span *ngIf="articleForm.get('abstract')?.errors?.['required']">Este campo es obligatorio.</span>
                            <span *ngIf="articleForm.get('abstract')?.errors?.['minlength']">Mínimo {{ articleForm.get('abstract')?.errors?.['minlength'].requiredLength }} caracteres.</span>
                            <span *ngIf="articleForm.get('abstract')?.errors?.['maxlength']">Máximo {{ articleForm.get('abstract')?.errors?.['maxlength'].requiredLength }} caracteres.</span>
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer" *ngIf="mode !== 'view'">
                <button class="btn-cancel" (click)="close()">Cancelar</button>
                <button class="btn-save" (click)="onSave()">
                    {{ mode === 'add' ? 'Publicar Artículo' : 'Guardar Cambios' }}
                </button>
            </div>

            <div class="modal-footer" *ngIf="mode === 'view'">
                <button class="btn-cancel" (click)="close()">Cerrar</button>
                <button class="btn-save" (click)="setMode('edit')">
                    <mat-icon>edit</mat-icon> Editar Artículo
                </button>
            </div>
        </div>
        </div>
    </ng-template>
</ion-modal>

<app-confirmation-modal [isOpen]="showConfirmModal" title="Confirmar Cambios"
    message="¿Estás seguro de que deseas guardar los cambios realizados en este artículo?" icon="library_books"
    confirmColor="var(--accent-color)" confirmText="Guardar" (confirmed)="executeSave()"
    (cancelled)="showConfirmModal = false">
</app-confirmation-modal>
