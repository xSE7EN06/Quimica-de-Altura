<ion-modal [isOpen]="isOpen" (didDismiss)="onDidDismiss()" class="plant-modal">
    <ng-template>
        <div class="modal-container">
            <!-- Navigation Arrows (Positioned outside modal card) -->
            <button class="nav-arrow prev" *ngIf="hasPrevious && mode !== 'add'" (click)="prev.emit()" title="Anterior">
                <mat-icon>chevron_left</mat-icon>
            </button>
            <button class="nav-arrow next" *ngIf="hasNext && mode !== 'add'" (click)="next.emit()" title="Siguiente">
                <mat-icon>chevron_right</mat-icon>
            </button>
            
            <div class="modal-wrapper" [class.is-viewing]="mode === 'view'">
            <!-- Restored Banner Design -->
            <div class="modal-header-image"
                [style.backgroundImage]="'url(' + (plantForm.get('imageUrl')?.value || 'assets/placeholder-plant.jpg') + ')'">
                <div class="header-overlay">
                    <button class="close-btn" (click)="close()">
                        <mat-icon>close</mat-icon>
                    </button>
                    <div class="header-content">
                        <span class="category-badge">Planta Medicinal</span>
                        <h1>{{ mode === 'add' ? 'Nueva Planta' : (plantForm.get('commonName')?.value) }}</h1>
                        <p class="scientific-name-header">{{ plantForm.get('scientificName')?.value }}</p>
                    </div>
                </div>
            </div>

            <div class="modal-scroll-content">
                <form [formGroup]="plantForm" class="plant-form">
                    <div class="form-section">
                        <h3>Información General</h3>
                        <div class="form-grid">
                            <div class="form-field">
                                <label>Nombre Común</label>
                                <input type="text" formControlName="commonName" [readOnly]="isReadOnly"
                                    placeholder="Ej. Toronjil Morado">
                                <div class="field-error" *ngIf="plantForm.get('commonName')?.invalid && plantForm.get('commonName')?.touched">
                                    <span *ngIf="plantForm.get('commonName')?.errors?.['required']">Este campo es obligatorio.</span>
                                    <span *ngIf="plantForm.get('commonName')?.errors?.['minlength']">Mínimo {{ plantForm.get('commonName')?.errors?.['minlength'].requiredLength }} caracteres.</span>
                                    <span *ngIf="plantForm.get('commonName')?.errors?.['maxlength']">Máximo {{ plantForm.get('commonName')?.errors?.['maxlength'].requiredLength }} caracteres.</span>
                                </div>
                            </div>
                            <div class="form-field">
                                <label>Nombre Científico</label>
                                <input type="text" formControlName="scientificName" [readOnly]="isReadOnly"
                                    placeholder="Ej. Agastache mexicana">
                                <div class="field-error" *ngIf="plantForm.get('scientificName')?.invalid && plantForm.get('scientificName')?.touched">
                                    <span *ngIf="plantForm.get('scientificName')?.errors?.['required']">Este campo es obligatorio.</span>
                                    <span *ngIf="plantForm.get('scientificName')?.errors?.['minlength']">Mínimo {{ plantForm.get('scientificName')?.errors?.['minlength'].requiredLength }} caracteres.</span>
                                    <span *ngIf="plantForm.get('scientificName')?.errors?.['maxlength']">Máximo {{ plantForm.get('scientificName')?.errors?.['maxlength'].requiredLength }} caracteres.</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Localización y Uso</h3>
                        <div class="form-grid">
                            <div class="form-field">
                                <label>Región de Origen</label>
                                <input type="text" formControlName="region" [readOnly]="isReadOnly"
                                    placeholder="Ej. Sierras frías">
                                <div class="field-error" *ngIf="plantForm.get('region')?.invalid && plantForm.get('region')?.touched">
                                    <span *ngIf="plantForm.get('region')?.errors?.['required']">Este campo es obligatorio.</span>
                                    <span *ngIf="plantForm.get('region')?.errors?.['minlength']">Mínimo {{ plantForm.get('region')?.errors?.['minlength'].requiredLength }} caracteres.</span>
                                    <span *ngIf="plantForm.get('region')?.errors?.['maxlength']">Máximo {{ plantForm.get('region')?.errors?.['maxlength'].requiredLength }} caracteres.</span>
                                </div>
                            </div>
                            <div class="form-field image-upload-field" *ngIf="!isReadOnly">
                                <label>Imagen de la Planta</label>
                                <div class="image-upload-zone" 
                                     [class.drag-over]="isDragOver"
                                     [class.has-image]="uploadedImageUrl"
                                     (dragover)="onDragOver($event)"
                                     (dragleave)="onDragLeave($event)"
                                     (drop)="onDrop($event)"
                                     (click)="fileInput.click()">
                                    <input #fileInput type="file" accept="image/*" (change)="onFileSelected($event)" style="display: none;">
                                    
                                    <div class="upload-content" *ngIf="!uploadedImageUrl">
                                        <mat-icon class="upload-icon">cloud_upload</mat-icon>
                                        <p class="upload-text">Arrastra y suelta una imagen aquí</p>
                                        <p class="upload-hint">o haz clic para seleccionar</p>
                                    </div>
                                    
                                    <div class="image-preview" *ngIf="uploadedImageUrl">
                                        <img [src]="uploadedImageUrl" alt="Plant preview">
                                        <div class="image-info">
                                            <span class="resolution">{{ imageResolution }}</span>
                                        </div>
                                        <button type="button" class="remove-image" (click)="removeImage($event)" title="Eliminar imagen">
                                            <mat-icon>delete</mat-icon>
                                        </button>
                                    </div>
                                </div>
                                <div class="field-error" *ngIf="plantForm.get('imageUrl')?.invalid && plantForm.get('imageUrl')?.touched">
                                    <span *ngIf="plantForm.get('imageUrl')?.errors?.['required']">Debes subir una imagen de la planta.</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Detalles Técnicos</h3>
                        <div class="form-field">
                            <label>Propiedades (separadas por coma)</label>
                            <input type="text" formControlName="properties" [readOnly]="isReadOnly"
                                placeholder="Relajante, Digestivo...">
                        </div>
                        <div class="form-field">
                            <label>Descripción General</label>
                            <textarea formControlName="description" [readOnly]="isReadOnly" rows="3"
                                placeholder="Descripción detallada de la planta..."></textarea>
                            <div class="field-error" *ngIf="plantForm.get('description')?.invalid && plantForm.get('description')?.touched">
                                <span *ngIf="plantForm.get('description')?.errors?.['required']">Este campo es obligatorio.</span>
                                <span *ngIf="plantForm.get('description')?.errors?.['minlength']">Mínimo {{ plantForm.get('description')?.errors?.['minlength'].requiredLength }} caracteres.</span>
                                <span *ngIf="plantForm.get('description')?.errors?.['maxlength']">Máximo {{ plantForm.get('description')?.errors?.['maxlength'].requiredLength }} caracteres.</span>
                            </div>
                        </div>
                        <div class="form-field">
                            <label>Características Identificativas</label>
                            <textarea formControlName="identifyingFeatures" [readOnly]="isReadOnly" rows="3"
                                placeholder="Tallo cuadrado, flores moradas..."></textarea>
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <div class="footer-actions">
                    <button *ngIf="isReadOnly" class="btn-edit" (click)="toggleEdit()">
                        <mat-icon>edit</mat-icon> Editar Información
                    </button>
                    <button *ngIf="!isReadOnly" class="btn-cancel" (click)="close()">Cancelar</button>
                    <button *ngIf="!isReadOnly" class="btn-save" (click)="onSave()">
                        <mat-icon>save</mat-icon> Guardar Cambios
                    </button>
                </div>
            </div>
        </div>
        </div>
    </ng-template>
</ion-modal>

<app-confirmation-modal [isOpen]="showConfirmModal" title="Confirmar Cambios"
    message="¿Estás seguro de que deseas actualizar la información de esta planta medicinal?" icon="save"
    confirmColor="var(--accent-color)" confirmText="Guardar" (confirmed)="executeSave()"
    (cancelled)="showConfirmModal = false">
</app-confirmation-modal>